const testString = "transloadit=%7B%22ok%22%3A%22ASSEMBLY_COMPLETED%22%2C%22http_code%22%3A200%2C%22message%22%3A%22The%20Assembly%20was%20successfully%20completed.%22%2C%22assembly_id%22%3A%224a99676af2fb4dcbb410c249737adff1%22%2C%22parent_id%22%3Anull%2C%22account_id%22%3A%2258780b415f124c0f99f6da702e762ad7%22%2C%22account_name%22%3A%22hello-world-mm%22%2C%22account_slug%22%3A%22hello-world-mm%22%2C%22template_id%22%3A%2212cb3d91ded94271a7345c43b4784972%22%2C%22template_name%22%3A%22s3-test%22%2C%22instance%22%3A%22fuyo.transloadit.com%22%2C%22assembly_url%22%3A%22http%3A%2F%2Fapi2.fuyo.transloadit.com%2Fassemblies%2F4a99676af2fb4dcbb410c249737adff1%22%2C%22assembly_ssl_url%22%3A%22https%3A%2F%2Fapi2-fuyo.transloadit.com%2Fassemblies%2F4a99676af2fb4dcbb410c249737adff1%22%2C%22uppyserver_url%22%3A%22https%3A%2F%2Fapi2-fuyo.transloadit.com%2Fcompanion%2F%22%2C%22companion_url%22%3A%22https%3A%2F%2Fapi2-fuyo.transloadit.com%2Fcompanion%2F%22%2C%22websocket_url%22%3A%22https%3A%2F%2Fapi2-fuyo.transloadit.com%2Fws20259%22%2C%22tus_url%22%3A%22https%3A%2F%2Fapi2-fuyo.transloadit.com%2Fresumable%2Ffiles%2F%22%2C%22bytes_received%22%3A121337%2C%22bytes_expected%22%3A121337%2C%22upload_duration%22%3A1.498%2C%22client_agent%22%3Anull%2C%22client_ip%22%3Anull%2C%22client_referer%22%3Anull%2C%22transloadit_client%22%3A%22uppy-core%3A2.1.4%2Cuppy-transloadit%3A2.0.5%2Cuppy-tus%3A2.1.2%22%2C%22start_date%22%3A%222022%2F01%2F27%2004%3A38%3A36%20GMT%22%2C%22upload_meta_data_extracted%22%3Atrue%2C%22warnings%22%3A%5B%5D%2C%22is_infinite%22%3Afalse%2C%22has_dupe_jobs%22%3Afalse%2C%22execution_start%22%3A%222022%2F01%2F27%2004%3A38%3A38%20GMT%22%2C%22execution_duration%22%3A1.637%2C%22queue_duration%22%3A0.009%2C%22jobs_queue_duration%22%3A0.05%2C%22notify_start%22%3A%222022%2F01%2F27%2004%3A38%3A39%20GMT%22%2C%22notify_url%22%3A%22https%3A%2F%2Fboring-varahamihira-cc7a90.netlify.app%2F.netlify%2Ffunctions%2FonboardRecording%22%2C%22notify_status%22%3A%22processing%22%2C%22notify_response_code%22%3Anull%2C%22notify_duration%22%3Anull%2C%22notifications%22%3A%5B%7B%22id%22%3A%228efbce18712e4597aefadfc0e672486a%22%2C%22url%22%3A%22https%3A%2F%2Fboring-varahamihira-cc7a90.netlify.app%2F.netlify%2Ffunctions%2FonboardRecording%22%2C%22created%22%3A%222022-01-27%2004%3A38%3A39%22%2C%22responseCode%22%3Anull%2C%22responseData%22%3Anull%2C%22error%22%3Anull%2C%22duration%22%3Anull%2C%22status%22%3A%22processing%22%7D%5D%2C%22last_job_completed%22%3A%222022%2F01%2F27%2004%3A38%3A39%20GMT%22%2C%22fields%22%3A%7B%22associate_with_template_id%22%3A%2212cb3d91ded94271a7345c43b4784972%22%7D%2C%22running_jobs%22%3A%5B%5D%2C%22bytes_usage%22%3A324140%2C%22executing_jobs%22%3A%5B%5D%2C%22started_jobs%22%3A%5B%22%3Aoriginal%3A%3A%3Aoriginal%22%2C%22flac_encoded%3A%3A%3Aoriginal%22%2C%22exported%3A%3A%3Aoriginal%22%2C%22exported%3A%3Aflac_encoded%22%5D%2C%22parent_assembly_status%22%3Anull%2C%22params%22%3A%22%7B%5C%22steps%5C%22%3A%7B%5C%22%3Aoriginal%5C%22%3A%7B%5C%22robot%5C%22%3A%5C%22%2Fupload%2Fhandle%5C%22%7D%2C%5C%22flac_encoded%5C%22%3A%7B%5C%22use%5C%22%3A%5C%22%3Aoriginal%5C%22%2C%5C%22robot%5C%22%3A%5C%22%2Faudio%2Fencode%5C%22%2C%5C%22result%5C%22%3Atrue%2C%5C%22preset%5C%22%3A%5C%22flac%5C%22%2C%5C%22ffmpeg_stack%5C%22%3A%5C%22v4.3.1%5C%22%7D%2C%5C%22exported%5C%22%3A%7B%5C%22robot%5C%22%3A%5C%22%2Fs3%2Fstore%5C%22%2C%5C%22use%5C%22%3A%5B%5C%22flac_encoded%5C%22%2C%5C%22%3Aoriginal%5C%22%5D%2C%5C%22credentials%5C%22%3A%5C%22s3_creds2%5C%22%2C%5C%22acl%5C%22%3A%5C%22bucket-default%5C%22%7D%7D%2C%5C%22notify_url%5C%22%3A%5C%22https%3A%2F%2Fboring-varahamihira-cc7a90.netlify.app%2F.netlify%2Ffunctions%2FonboardRecording%5C%22%2C%5C%22auth%5C%22%3A%7B%5C%22key%5C%22%3A%5C%22%2A%2A%2A%2A%5C%22%2C%5C%22expires%5C%22%3A%5C%222022%2F01%2F27%2012%3A38%3A34%2B00%3A00%5C%22%7D%7D%22%2C%22template%22%3A%22%7B%5C%22steps%5C%22%3A%7B%5C%22%3Aoriginal%5C%22%3A%7B%5C%22robot%5C%22%3A%5C%22%2Fupload%2Fhandle%5C%22%7D%2C%5C%22flac_encoded%5C%22%3A%7B%5C%22use%5C%22%3A%5C%22%3Aoriginal%5C%22%2C%5C%22robot%5C%22%3A%5C%22%2Faudio%2Fencode%5C%22%2C%5C%22result%5C%22%3Atrue%2C%5C%22preset%5C%22%3A%5C%22flac%5C%22%2C%5C%22ffmpeg_stack%5C%22%3A%5C%22v4.3.1%5C%22%7D%2C%5C%22exported%5C%22%3A%7B%5C%22robot%5C%22%3A%5C%22%2Fs3%2Fstore%5C%22%2C%5C%22use%5C%22%3A%5B%5C%22flac_encoded%5C%22%2C%5C%22%3Aoriginal%5C%22%5D%2C%5C%22credentials%5C%22%3A%5C%22s3_creds2%5C%22%2C%5C%22acl%5C%22%3A%5C%22bucket-default%5C%22%7D%7D%2C%5C%22notify_url%5C%22%3A%5C%22https%3A%2F%2Fboring-varahamihira-cc7a90.netlify.app%2F.netlify%2Ffunctions%2FonboardRecording%5C%22%7D%22%2C%22merged_params%22%3A%22%7B%5C%22steps%5C%22%3A%7B%5C%22%3Aoriginal%5C%22%3A%7B%5C%22robot%5C%22%3A%5C%22%2Fupload%2Fhandle%5C%22%7D%2C%5C%22flac_encoded%5C%22%3A%7B%5C%22use%5C%22%3A%5C%22%3Aoriginal%5C%22%2C%5C%22robot%5C%22%3A%5C%22%2Faudio%2Fencode%5C%22%2C%5C%22result%5C%22%3Atrue%2C%5C%22preset%5C%22%3A%5C%22flac%5C%22%2C%5C%22ffmpeg_stack%5C%22%3A%5C%22v4.3.1%5C%22%7D%2C%5C%22exported%5C%22%3A%7B%5C%22robot%5C%22%3A%5C%22%2Fs3%2Fstore%5C%22%2C%5C%22use%5C%22%3A%5B%5C%22flac_encoded%5C%22%2C%5C%22%3Aoriginal%5C%22%5D%2C%5C%22credentials%5C%22%3A%5C%22s3_creds2%5C%22%2C%5C%22acl%5C%22%3A%5C%22bucket-default%5C%22%7D%7D%2C%5C%22notify_url%5C%22%3A%5C%22https%3A%2F%2Fboring-varahamihira-cc7a90.netlify.app%2F.netlify%2Ffunctions%2FonboardRecording%5C%22%2C%5C%22allow_steps_override%5C%22%3Atrue%2C%5C%22auth%5C%22%3A%7B%5C%22key%5C%22%3A%5C%22%2A%2A%2A%2A%5C%22%2C%5C%22expires%5C%22%3A%5C%222022%2F01%2F27%2012%3A38%3A34%2B00%3A00%5C%22%7D%2C%5C%22template_id%5C%22%3A%5C%2212cb3d91ded94271a7345c43b4784972%5C%22%7D%22%2C%22expected_tus_uploads%22%3A1%2C%22started_tus_uploads%22%3A1%2C%22finished_tus_uploads%22%3A1%2C%22uploads%22%3A%5B%7B%22id%22%3A%22a48c0c4435bd4d2095206c0aa41ffdbc%22%2C%22name%22%3A%22TestAudio.mp4%22%2C%22basename%22%3A%22TestAudio%22%2C%22ext%22%3A%22mp4%22%2C%22size%22%3A120340%2C%22mime%22%3A%22audio%2Fmp4%22%2C%22type%22%3A%22audio%22%2C%22field%22%3A%22file%22%2C%22md5hash%22%3A%226ece02a7232bbe1afd6d1047889e557a%22%2C%22original_id%22%3A%22a48c0c4435bd4d2095206c0aa41ffdbc%22%2C%22original_basename%22%3A%22TestAudio%22%2C%22original_name%22%3A%22TestAudio.mp4%22%2C%22original_path%22%3A%22%2F%22%2C%22original_md5hash%22%3A%226ece02a7232bbe1afd6d1047889e557a%22%2C%22from_batch_import%22%3Afalse%2C%22is_tus_file%22%3Atrue%2C%22tus_upload_url%22%3A%22https%3A%2F%2Fapi2-fuyo.transloadit.com%2Fresumable%2Ffiles%2Fb5eae57b863f395ca2dd40167e2b7c01%2BZDLxUIiMzOEhNs5Br1k0hH6Dm_tz1.2sPfhaeEeW_OizZ8A.C6aMebrrsjXzl44pBojGMpFJQ5dLBLTlvzsHM47qDNzj38CG3I5Zpp7LZjVBaZQM8HKuhpZzPKWWT4JY%22%2C%22url%22%3A%22http%3A%2F%2Fmm-transloadit-testing01.s3.us-west-1.amazonaws.com%2Fa4%2F8c0c4435bd4d2095206c0aa41ffdbc%2FTestAudio.mp4%22%2C%22ssl_url%22%3A%22https%3A%2F%2Fmm-transloadit-testing01.s3.us-west-1.amazonaws.com%2Fa4%2F8c0c4435bd4d2095206c0aa41ffdbc%2FTestAudio.mp4%22%2C%22meta%22%3A%7B%22duration%22%3A14.63%2C%22audio_bitrate%22%3A63560%2C%22overall_bitrate%22%3A65814%2C%22audio_samplerate%22%3A44100%2C%22audio_channels%22%3A1%2C%22audio_codec%22%3A%22ffaac%22%2C%22encoder%22%3A%22com.apple.VoiceMemos%20%28iOS%2010.3.3%29%22%2C%22has_artwork%22%3Afalse%7D%7D%5D%2C%22results%22%3A%7B%22flac_encoded%22%3A%5B%7B%22id%22%3A%227111f9b93c1b4b70860e65b19f3f568c%22%2C%22name%22%3A%22TestAudio.flac%22%2C%22basename%22%3A%22TestAudio%22%2C%22ext%22%3A%22flac%22%2C%22size%22%3A1128082%2C%22mime%22%3A%22audio%2Fflac%22%2C%22type%22%3A%22audio%22%2C%22field%22%3A%22file%22%2C%22md5hash%22%3A%22ec6fc875a6a884f1ce16abd6bc3d08c1%22%2C%22original_id%22%3A%22a48c0c4435bd4d2095206c0aa41ffdbc%22%2C%22original_basename%22%3A%22TestAudio%22%2C%22original_name%22%3A%22TestAudio.mp4%22%2C%22original_path%22%3A%22%2F%22%2C%22original_md5hash%22%3A%226ece02a7232bbe1afd6d1047889e557a%22%2C%22from_batch_import%22%3Afalse%2C%22is_tus_file%22%3Afalse%2C%22tus_upload_url%22%3Anull%2C%22url%22%3A%22http%3A%2F%2Fmm-transloadit-testing01.s3.us-west-1.amazonaws.com%2F71%2F11f9b93c1b4b70860e65b19f3f568c%2FTestAudio.flac%22%2C%22ssl_url%22%3A%22https%3A%2F%2Fmm-transloadit-testing01.s3.us-west-1.amazonaws.com%2F71%2F11f9b93c1b4b70860e65b19f3f568c%2FTestAudio.flac%22%2C%22meta%22%3A%7B%22duration%22%3A14.65%2C%22audio_bitrate%22%3A616000%2C%22overall_bitrate%22%3A616018%2C%22audio_samplerate%22%3A44100%2C%22audio_channels%22%3A1%2C%22audio_codec%22%3A%22ffflac%22%2C%22encoder%22%3A%22Lavf58.45.100%22%2C%22has_artwork%22%3Afalse%2C%22mean_volume%22%3Anull%2C%22beats_per_minute%22%3Anull%2C%22bit_depth%22%3A24%2C%22album%22%3Anull%2C%22year%22%3Anull%2C%22genre%22%3Anull%2C%22artist%22%3Anull%2C%22comment%22%3Anull%2C%22performer%22%3Anull%2C%22lyrics%22%3Anull%2C%22title%22%3Anull%2C%22band%22%3Anull%2C%22disc%22%3Anull%2C%22track%22%3Anull%7D%2C%22queue%22%3A%22live%22%2C%22queueTime%22%3A0.01%2C%22execTime%22%3A0.41%2C%22cost%22%3A312106%7D%5D%2C%22%3Aoriginal%22%3A%5B%7B%22id%22%3A%22a48c0c4435bd4d2095206c0aa41ffdbc%22%2C%22name%22%3A%22TestAudio.mp4%22%2C%22basename%22%3A%22TestAudio%22%2C%22ext%22%3A%22mp4%22%2C%22size%22%3A120340%2C%22mime%22%3A%22audio%2Fmp4%22%2C%22type%22%3A%22audio%22%2C%22field%22%3A%22file%22%2C%22md5hash%22%3A%226ece02a7232bbe1afd6d1047889e557a%22%2C%22original_id%22%3A%22a48c0c4435bd4d2095206c0aa41ffdbc%22%2C%22original_basename%22%3A%22TestAudio%22%2C%22original_name%22%3A%22TestAudio.mp4%22%2C%22original_path%22%3A%22%2F%22%2C%22original_md5hash%22%3A%226ece02a7232bbe1afd6d1047889e557a%22%2C%22from_batch_import%22%3Afalse%2C%22is_tus_file%22%3Afalse%2C%22tus_upload_url%22%3Anull%2C%22url%22%3A%22http%3A%2F%2Fmm-transloadit-testing01.s3.us-west-1.amazonaws.com%2Fa4%2F8c0c4435bd4d2095206c0aa41ffdbc%2FTestAudio.mp4%22%2C%22ssl_url%22%3A%22https%3A%2F%2Fmm-transloadit-testing01.s3.us-west-1.amazonaws.com%2Fa4%2F8c0c4435bd4d2095206c0aa41ffdbc%2FTestAudio.mp4%22%2C%22meta%22%3A%7B%22duration%22%3A14.63%2C%22audio_bitrate%22%3A63560%2C%22overall_bitrate%22%3A65814%2C%22audio_samplerate%22%3A44100%2C%22audio_channels%22%3A1%2C%22audio_codec%22%3A%22ffaac%22%2C%22encoder%22%3A%22com.apple.VoiceMemos%20%28iOS%2010.3.3%29%22%2C%22has_artwork%22%3Afalse%7D%2C%22queue%22%3A%22live%22%2C%22queueTime%22%3A0.01%2C%22execTime%22%3A0.51%2C%22cost%22%3A24068%7D%5D%7D%2C%22build_id%22%3A%221752284114%22%7D&signature=d57b98f3baf2e2d029be8037064877358ca46aa8"

const formidable = require('formidable')
const querystring = require('querystring');
const crypto     = require('crypto');

queryObj = querystring.parse(testString);

const T_SECRET = 'c73c537b48f7e9a02ad2b4c4f27a6181cf0f670c';

const checkSignature = (fields, authSecret) => {
  const receivedSignature = fields.signature
  const payload           = fields.transloadit

  const calculatedSignature = crypto
    .createHmac('sha1', authSecret)
    .update(Buffer.from(payload, 'utf-8'))
    .digest('hex')

  return calculatedSignature === receivedSignature
}

// console.log(testString);
// console.log(JSON.stringify(querystring.parse(testString).transloadit, null, 2));
// console.log(JSON.stringify(querystring.parse(testString).transloadit, null, 2));
// console.log(JSON.stringify(querystring.parse(testString).transloadit, null, 2));

// console.log(JSON.parse(queryObj.transloadit));
// console.log(JSON.parse(queryObj.transloadit).results);
// console.log(JSON.stringify(JSON.parse(queryObj.transloadit).results, null, 2));
console.log(JSON.stringify(JSON.parse(queryObj.transloadit), null, 2));
console.log(queryObj.signature);
console.log(checkSignature(queryObj, T_SECRET));

// console.log(decodeURIComponent(testString));

// const form = new formidable.IncomingForm();
// form.parse(testString, (err, fields, files) => {
//   if (err) {
//     return respond(res, 500, [`Error while parsing multipart form`, err])
//   };
//   console.log(fields);
//   return {
//     statusCode: 200,
//   };

// });